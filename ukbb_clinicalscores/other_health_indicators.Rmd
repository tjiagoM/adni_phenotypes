---
title: "Other health indicators"
output: html_notebook
---

```{r}
library(dplyr)
library(RSQLite)
library(ggplot2)
library(broom.mixed)
library(tidyr)
library(brms)
library(bayesplot)
library(rstan)
library(multcomp)
library(coda)
library(tidybayes)
library(gridExtra)

# options for rstan
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

In this notebook we'll examine the correlation between the neuroimaging derived phenotype scores and clinical scores in the UK biobank population.

```{r}
# create sqlite connection
ukbb.db <- DBI::dbConnect(SQLite(),
                          "../data/ukb40183.db")
```

```{r}
# define clinical score
threshold = 0.5

getdata <- function(clinscore, threshold){
  # pairs matching
  alldata <- dbGetQuery(ukbb.db,
                        sql(paste("SELECT clinicaldata.eid, clinicaldata.noncancer_code_selfreported,",
                                  "demogs.age, demogs.visit,",
                                  paste("clinicaldata", clinscore, sep = "."), " AS clinscore,",
                                  "ukbb_t1_phenotype.mean",
                                  "FROM clinicaldata",
                                  "JOIN ukbb_t1_phenotype, demogs, baseline ON clinicaldata.eid = ukbb_t1_phenotype.eid",
                                  "AND clinicaldata.eid = demogs.eid",
                                  "AND clinicaldata.visit = demogs.visit",
                                  "AND clinicaldata.eid = baseline.eid",
                                  "AND ukbb_t1_phenotype.eid = baseline.eid",
                                  "AND demogs.eid = baseline.eid",
                                  "AND ukbb_t1_phenotype.eid = demogs.eid",
                                  "WHERE demogs.age IS NOT ''",
                                  "AND baseline.imaging = 1",
                                  "AND", paste("clinicaldata", clinscore, sep = "."), "IS NOT ''"))) %>%
    filter(visit <= 2) %>%
    group_by(eid) %>%
    filter(visit == max(visit))

  alldata$adlike <- sapply(alldata$mean,
                           function(x, thr) if (x >=  thr) { return("Positive") } else {return("Negative")},
                           thr = threshold)
  
  alldata <- alldata %>%
    mutate(adlike = ifelse(noncancer_code_selfreported == "1263", "AD", adlike)) %>%
    filter(adlike != "AD") # filter out those with AD at recruitment
  
  
  alldata$adlike <- as.factor(alldata$adlike)
  alldata$clinscore <- as.numeric(alldata$clinscore)
  alldata$age <- as.numeric(alldata$age)
  
  # normalise age
  mean_age <- mean(alldata$age)
  sd_age <- sd(alldata$age)
  alldata$age <- (alldata$age - mean_age) / sd_age
  
  return(alldata)
}

```

# Other health indicators

## hand grip

### left
```{r}
clinscore_name = "Hand grip"

lefthand <- getdata(clinscore = "hand_grip_left",
                    threshold = threshold)
righthand <- getdata(clinscore = "hand_grip_right",
                     threshold = threshold)
alldata <- inner_join(lefthand[,c("eid", "clinscore")],
                      righthand,
                      by = "eid") %>%
  group_by(eid) %>%
  mutate(clinscore = mean(c(clinscore.x, clinscore.y)))

rm("lefthand",
   "righthand")

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
p <- ggplot(alldata,
            aes(y = clinscore,
                x = adlike,
                fill = adlike)) +
  geom_boxplot() +
  labs(y = clinscore_name) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# Bayesian analysis
priors <- c(prior(cauchy(0, 10), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"), 
            prior(cauchy(0, 10), class = "sigma"))

cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata, 
                iter = 5000, warmup = 1000, chains = 4, 
                prior = priors)

summary(cog_brms)

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"][["clinscore"]]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```

## waist circumference
```{r}
clinscore = "waist_circumference"
clinscore_name = "Waist circumference"

alldata <- getdata(clinscore = clinscore,
                   threshold = threshold)

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
p <- ggplot(alldata,
            aes(y = clinscore,
                x = adlike,
                fill = adlike)) +
  geom_boxplot() +
  labs(y = clinscore_name) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# Bayesian analysis
priors <- c(prior(normal(85, 50), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"), 
            prior(cauchy(0, 10), class = "sigma"))

cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata, 
                iter = 5000, warmup = 1000, chains = 4, 
                prior = priors)

summary(cog_brms)

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"][["clinscore"]]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```


## hip circumference
```{r}
clinscore = "hip_circumference"
clinscore_name = "Hip circumference"

alldata <- getdata(clinscore = clinscore,
                   threshold = threshold)

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
p <- ggplot(alldata,
            aes(y = clinscore,
                x = adlike,
                fill = adlike)) +
  geom_boxplot() +
  labs(y = clinscore_name) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# Bayesian analysis
priors <- c(prior(normal(100, 50), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"), 
            prior(cauchy(0, 10), class = "sigma"))

cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata, 
                iter = 5000, warmup = 1000, chains = 4, 
                prior = priors)

summary(cog_brms)

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"][["clinscore"]]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```


## BP
### systolic - manual
```{r}
clinscore_name = "Systolic BP"

bp_manual <- getdata(clinscore = "BP_systolic_manual",
                     threshold = threshold)

# diastolic/systolic seems to be mis-labelled
bp_automatic <- getdata(clinscore = "BP_diastolic_automated",
                        threshold = threshold)
alldata <- rbind(bp_manual,
                 bp_automatic) %>%
  group_by(eid) %>%
  mutate(clinscore = mean(clinscore))

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
p <- ggplot(alldata,
            aes(y = clinscore,
                x = adlike,
                fill = adlike)) +
  geom_boxplot() +
  labs(y = clinscore_name) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# Bayesian analysis
priors <- c(prior(normal(130, 50), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"), 
            prior(cauchy(0, 10), class = "sigma"))

cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata, 
                iter = 5000, warmup = 1000, chains = 4, 
                prior = priors)

summary(cog_brms)

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"][["clinscore"]]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```


### diastolic - manual
```{r}
clinscore_name = "Diastolic BP"

bp_manual <- getdata(clinscore = "BP_diastolic_manual",
                     threshold = threshold)

# mislabelling of systolic/diastolic data
bp_automatic <- getdata(clinscore = "BP_systolic_automated",
                        threshold = threshold)
alldata <- rbind(bp_manual,
                 bp_automatic) %>%
  group_by(eid) %>%
  mutate(clinscore = mean(clinscore))

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
p <- ggplot(alldata,
            aes(y = clinscore,
                x = adlike,
                fill = adlike)) +
  geom_boxplot() +
  labs(y = clinscore_name) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# Bayesian analysis
priors <- c(prior(normal(80, 50), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"), 
            prior(cauchy(0, 10), class = "sigma"))

cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata, 
                iter = 5000, warmup = 1000, chains = 4, 
                prior = priors)

summary(cog_brms)

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"][["clinscore"]]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```


## Combined BP
```{r}
clinscore_name = "Combined BP"

bp_manual <- getdata(clinscore = "BP_systolic_manual",
                     threshold = threshold)

# diastolic/systolic seems to be mis-labelled
bp_automatic <- getdata(clinscore = "BP_diastolic_automated",
                        threshold = threshold)
alldata_systolic <- rbind(bp_manual,
                 bp_automatic) %>%
  group_by(eid) %>%
  mutate(clinscore = mean(clinscore))

# diastolic BP
bp_manual <- getdata(clinscore = "BP_diastolic_manual",
                     threshold = threshold)

# mislabelling of systolic/diastolic data
bp_automatic <- getdata(clinscore = "BP_systolic_automated",
                        threshold = threshold)
alldata_diastolic <- rbind(bp_manual,
                 bp_automatic) %>%
  group_by(eid) %>%
  mutate(clinscore = mean(clinscore))


# combine
alldata <- inner_join(alldata_systolic, alldata_diastolic[,c("eid", "clinscore")],
                       by = "eid") %>%
  mutate(clinscore = clinscore.x + clinscore.y)

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
p <- ggplot(alldata,
            aes(y = clinscore,
                x = adlike,
                fill = adlike)) +
  geom_boxplot() +
  labs(y = clinscore_name) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# Bayesian analysis
priors <- c(prior(normal(220, 50), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"), 
            prior(cauchy(0, 10), class = "sigma"))

cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata, 
                iter = 5000, warmup = 1000, chains = 4, 
                prior = priors)

summary(cog_brms)

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"][["clinscore"]]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```

## Pulse pressure
```{r}
clinscore_name = "Pulse pressure"

bp_manual <- getdata(clinscore = "BP_systolic_manual",
                     threshold = threshold)

# diastolic/systolic seems to be mis-labelled
bp_automatic <- getdata(clinscore = "BP_diastolic_automated",
                        threshold = threshold)
alldata_systolic <- rbind(bp_manual,
                 bp_automatic) %>%
  group_by(eid) %>%
  mutate(clinscore = mean(clinscore))

# diastolic BP
bp_manual <- getdata(clinscore = "BP_diastolic_manual",
                     threshold = threshold)

# mislabelling of systolic/diastolic data
bp_automatic <- getdata(clinscore = "BP_systolic_automated",
                        threshold = threshold)
alldata_diastolic <- rbind(bp_manual,
                 bp_automatic) %>%
  group_by(eid) %>%
  mutate(clinscore = mean(clinscore))


# combine
alldata <- inner_join(alldata_systolic, alldata_diastolic[,c("eid", "clinscore")],
                       by = "eid") %>%
  mutate(clinscore = clinscore.x - clinscore.y)

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
p <- ggplot(alldata,
            aes(y = clinscore,
                x = adlike,
                fill = adlike)) +
  geom_boxplot() +
  labs(y = clinscore_name) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# Bayesian analysis
priors <- c(prior(normal(60, 50), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"), 
            prior(cauchy(0, 10), class = "sigma"))

cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata, 
                iter = 5000, warmup = 1000, chains = 4, 
                prior = priors)

summary(cog_brms)

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"][["clinscore"]]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```




## Sleep duration
```{r}
clinscore = "sleep_duration"
clinscore_name = "Sleep duration"

alldata <- getdata(clinscore = clinscore,
                   threshold = threshold) %>%
  filter(clinscore > 0)

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
p <- ggplot(alldata,
            aes(y = clinscore,
                x = adlike,
                fill = adlike)) +
  geom_boxplot() +
  labs(y = clinscore_name) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# Bayesian analysis
priors <- c(prior(normal(7, 10), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"), 
            prior(cauchy(0, 10), class = "sigma"))

cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata, 
                iter = 5000, warmup = 1000, chains = 4,
                #family = skew_normal(),
                prior = priors)

summary(cog_brms)

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"][["clinscore"]]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```


## Alcohol frequency
```{r}
clinscore = "Alcohol_frequency"
clinscore_name = "Alcohol frequency"

alldata <- getdata(clinscore = clinscore,
                   threshold = threshold) %>%
  filter(clinscore >= 0)

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
p <- ggplot(alldata,
            aes(y = clinscore,
                x = adlike,
                fill = adlike)) +
  geom_boxplot() +
  labs(y = clinscore_name) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# Bayesian analysis
priors <- c(prior(cauchy(3, 50), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"), 
            prior(cauchy(0, 10), class = "sigma"))

cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata, 
                iter = 5000, warmup = 1000, chains = 4,
                prior = priors)

summary(cog_brms)

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```



```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"][["clinscore"]]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```


## Seen GP for depression
```{r}
clinscore = "seen_gp_depression"
clinscore_name = "Depression - GP consultation"

alldata <- getdata(clinscore = clinscore,
                   threshold = threshold) %>%
  filter(clinscore >= 0)

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
# change to proportions
total_pos = length(alldata[alldata$adlike == "Positive", "eid"][["eid"]])
total_neg = length(alldata[alldata$adlike == "Negative", "eid"][["eid"]])

alldata_summary <- alldata %>%
  group_by(adlike, clinscore) %>%
  summarise(n = length(eid))
alldata_summary$totals <- sapply(alldata_summary$adlike,
                                 function(x, total_pos, total_neg) if (x == "Positive") {return(total_pos)} else {return(total_neg)},
                                 total_pos = total_pos,
                                 total_neg = total_neg)
alldata_summary <- alldata_summary %>%
  group_by(adlike, clinscore) %>%
  mutate(proportion = n / totals)

p <- ggplot(alldata_summary,
            aes(y = proportion,
                x = adlike,
                fill = clinscore)) +
  geom_histogram(stat = "identity",
                 position = position_dodge2()) +
  labs(x = clinscore) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# prior
priors = c(prior(normal(0, 1),
                 class = "Intercept"))

# Bayesian analysis
cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata, 
                iter = 5000, warmup = 1000, chains = 4,
                family = bernoulli(),
                prior = priors)

summary(cog_brms)

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
ce <- conditional_effects(cog_brms, "adlike")

# ROPE for odds ratios in logistic regression
# https://cran.r-project.org/web/packages/bayestestR/vignettes/region_of_practical_equivalence.html
# or_rope = pi / sqrt(3) * ce$adlike$estimate__[[1]] 
or_rope = 0.01

plot(ce, plot = FALSE,
     errorbar_args = list(width = 0))[[1]] +
  labs(y = clinscore_name,
       x = "AD-like") +
  coord_flip() +
  scale_x_discrete(limits = c("Positive",
                              "Negative"),
                   labels = c("AD-like positive",
                              "AD-like negative")) +
  geom_rect(ymin = ce$adlike$estimate__[[1]] - or_rope,
            ymax = ce$adlike$estimate__[[1]] + or_rope,
            xmin = 0, xmax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_hline(yintercept = ce$adlike$estimate__[[1]], linetype = "dashed", colour = "blue") +
  geom_hline(yintercept = ce$adlike$estimate__[[1]] + or_rope, linetype = "dashed", colour = "blue") +
  geom_hline(yintercept = ce$adlike$estimate__[[1]] - or_rope, linetype = "dashed", colour = "blue") +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
#   scale_fill_discrete(name = clinscore_name,
#                       labels = seq(0, 3, by = 1)) +
#   scale_colour_discrete(name = clinscore_name,
#                         labels = seq(0, 3, by = 1))

```

```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"][["clinscore"]]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```


## Seen psychiatry for depression
```{r}
clinscore = "seen_psych_depression"
clinscore_name = "Depression - psychiatry consultation"

alldata <- getdata(clinscore = clinscore,
                   threshold = threshold) %>%
  filter(clinscore >= 0)

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
# change to proportions
total_pos = length(alldata[alldata$adlike == "Positive", "eid"][["eid"]])
total_neg = length(alldata[alldata$adlike == "Negative", "eid"][["eid"]])

alldata_summary <- alldata %>%
  group_by(adlike, clinscore) %>%
  summarise(n = length(eid))
alldata_summary$totals <- sapply(alldata_summary$adlike,
                                 function(x, total_pos, total_neg) if (x == "Positive") {return(total_pos)} else {return(total_neg)},
                                 total_pos = total_pos,
                                 total_neg = total_neg)
alldata_summary <- alldata_summary %>%
  group_by(adlike, clinscore) %>%
  mutate(proportion = n / totals)

p <- ggplot(alldata_summary,
            aes(y = proportion,
                x = adlike,
                fill = clinscore)) +
  geom_histogram(stat = "identity",
                 position = position_dodge2()) +
  labs(x = clinscore) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)
```

```{r}
# prior
priors = c(prior(normal(0, 1),
                 class = "Intercept"))

# Bayesian analysis
cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata, 
                iter = 5000, warmup = 1000, chains = 4,
                family = bernoulli(),
                prior = priors)

summary(cog_brms)

```

```{r, fig.height=2.5, fig.width=6}
ce <- conditional_effects(cog_brms, "adlike")

# ROPE for odds ratios in logistic regression
# https://cran.r-project.org/web/packages/bayestestR/vignettes/region_of_practical_equivalence.html
# or_rope = pi / sqrt(3) * ce$adlike$estimate__[[1]] 
or_rope = 0.01

plot(ce, plot = FALSE,
     errorbar_args = list(width = 0))[[1]] +
  labs(y = clinscore_name,
       x = "AD-like") +
  coord_flip() +
  scale_x_discrete(limits = c("Positive",
                              "Negative"),
                   labels = c("AD-like positive",
                              "AD-like negative")) +
  geom_rect(ymin = ce$adlike$estimate__[[1]] - or_rope,
            ymax = ce$adlike$estimate__[[1]] + or_rope,
            xmin = 0, xmax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_hline(yintercept = ce$adlike$estimate__[[1]], linetype = "dashed", colour = "blue") +
  geom_hline(yintercept = ce$adlike$estimate__[[1]] + or_rope, linetype = "dashed", colour = "blue") +
  geom_hline(yintercept = ce$adlike$estimate__[[1]] - or_rope, linetype = "dashed", colour = "blue") +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"][["clinscore"]]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```


## Overall health rating
```{r}
clinscore = "overall_health_rating"
clinscore_name = "Overall health rating"

alldata <- getdata(clinscore = clinscore,
                   threshold = threshold) %>%
  filter(clinscore > 0)

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
# change to proportions
total_pos = length(alldata[alldata$adlike == "Positive", "eid"][["eid"]])
total_neg = length(alldata[alldata$adlike == "Negative", "eid"][["eid"]])

alldata_summary <- alldata %>%
  group_by(adlike, clinscore) %>%
  summarise(n = length(eid))
alldata_summary$totals <- sapply(alldata_summary$adlike,
                                 function(x, total_pos, total_neg) if (x == "Positive") {return(total_pos)} else {return(total_neg)},
                                 total_pos = total_pos,
                                 total_neg = total_neg)
alldata_summary <- alldata_summary %>%
  group_by(adlike, clinscore) %>%
  mutate(proportion = n / totals)

p <- ggplot(alldata_summary,
            aes(y = proportion,
                x = adlike,
                fill = clinscore)) +
  geom_histogram(stat = "identity",
                 position = position_dodge2()) +
  labs(x = clinscore) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# priors
priors <- c(prior(cauchy(0, 10), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"))

# Bayesian analysis
cog_brms <- brm(clinscore ~  1 + adlike + age, 
                data = alldata, 
                iter = 5000, warmup = 1000, chains = 4,
                family = acat("probit"),
                prior = priors)

summary(cog_brms)
```

```{r}
ce <- conditional_effects(cog_brms, "adlike", categorical = TRUE)

p2 <- plot(ce, plot = FALSE)[[1]] +
  ylim(0.62, .645) +
  theme(legend.position = "None",
        axis.title.x = element_blank())

p3 <- plot(ce, plot = FALSE)[[1]] +
  ylim(0., .23) +
  theme(legend.position = "None",
        axis.title.x = element_blank())

p1 <- plot(ce, plot = FALSE)[[1]] +
  labs(x = "AD-like") +
  scale_fill_discrete(name = clinscore_name,
                      labels = c("Excellent",
                                 "Good",
                                 "Fair",
                                 "Poor")) +
  scale_colour_discrete(name = clinscore_name,
                        labels = c("Excellent",
                                   "Good",
                                   "Fair",
                                   "Poor"))

grid.arrange(grobs = list(p1, p2, p3),
             widths = c(2,1),
             layout_matrix = rbind(c(1,2),
                                   c(1,3)))

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[4,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[4,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- spread_draws(cog_brms, b_adlikePositive, b_Intercept[])
# select the third intercept
cog_brms_draws <- cog_brms_draws[seq(nrow(cog_brms_draws) / 3) * 3,]

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"][["clinscore"]]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```


## Hearing difficulties
```{r}
clinscore = "hearing_difficulties"
clinscore_name = "Hearing difficulty"

alldata <- getdata(clinscore = clinscore,
                   threshold = threshold) %>%
  filter(clinscore >= 0 && clinscore < 10)

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
# change to proportions
total_pos = length(alldata[alldata$adlike == "Positive", "eid"][["eid"]])
total_neg = length(alldata[alldata$adlike == "Negative", "eid"][["eid"]])

alldata_summary <- alldata %>%
  group_by(adlike, clinscore) %>%
  summarise(n = length(eid))
alldata_summary$totals <- sapply(alldata_summary$adlike,
                                 function(x, total_pos, total_neg) if (x == "Positive") {return(total_pos)} else {return(total_neg)},
                                 total_pos = total_pos,
                                 total_neg = total_neg)
alldata_summary <- alldata_summary %>%
  group_by(adlike, clinscore) %>%
  mutate(proportion = n / totals)

p <- ggplot(alldata_summary,
            aes(y = proportion,
                x = adlike,
                fill = clinscore)) +
  geom_histogram(stat = "identity",
                 position = position_dodge2()) +
  labs(x = clinscore) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# prior
priors = c(prior(normal(0, 1),
                 class = "Intercept"))

# Bayesian analysis
cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata, 
                iter = 5000, warmup = 1000, chains = 4,
                family = bernoulli(),
                prior = priors)

summary(cog_brms)

```

```{r, fig.height=2.5, fig.width=6}
ce <- conditional_effects(cog_brms, "adlike")

# ROPE for odds ratios in logistic regression
# https://cran.r-project.org/web/packages/bayestestR/vignettes/region_of_practical_equivalence.html
# or_rope = pi / sqrt(3) * ce$adlike$estimate__[[1]] 
or_rope = 0.01

plot(ce, plot = FALSE,
     errorbar_args = list(width = 0))[[1]] +
  labs(y = clinscore_name,
       x = "AD-like") +
  coord_flip() +
  scale_x_discrete(limits = c("Positive",
                              "Negative"),
                   labels = c("AD-like positive",
                              "AD-like negative")) +
  geom_rect(ymin = ce$adlike$estimate__[[1]] - or_rope,
            ymax = ce$adlike$estimate__[[1]] + or_rope,
            xmin = 0, xmax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_hline(yintercept = ce$adlike$estimate__[[1]], linetype = "dashed", colour = "blue") +
  geom_hline(yintercept = ce$adlike$estimate__[[1]] + or_rope, linetype = "dashed", colour = "blue") +
  geom_hline(yintercept = ce$adlike$estimate__[[1]] - or_rope, linetype = "dashed", colour = "blue") +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
#   scale_fill_discrete(name = clinscore_name,
#                       labels = seq(0, 3, by = 1)) +
#   scale_colour_discrete(name = clinscore_name,
#                         labels = seq(0, 3, by = 1))
```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"][["clinscore"]]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```


## Neuroticism score
```{r}
clinscore = "neuroticism_score"
clinscore_name = "Neuroticism score"

alldata <- getdata(clinscore = clinscore,
                   threshold = threshold) %>%
  filter(clinscore >= 0)

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
p <- ggplot(alldata,
            aes(y = clinscore,
                x = adlike,
                fill = adlike)) +
  geom_boxplot() +
  labs(y = clinscore_name) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# Bayesian analysis
priors <- c(prior(student_t(3, 3, 3), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"),
            prior(cauchy(0, 10), class = "sigma"))

cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata,
                iter = 5000, warmup = 1000, chains = 4,
                family = student(),
                prior = priors)

summary(cog_brms)

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"][["clinscore"]]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```


## Smoking
```{r}
clinscore = "ever_smoked"
clinscore_name = "Ever smoked"

# pairs matching
alldata <- dbGetQuery(ukbb.db,
                      sql(paste("SELECT clinicaldata.eid, clinicaldata.noncancer_code_selfreported,",
                                "demogs.age, demogs.visit,",
                                paste("demogs", clinscore, sep = "."), " AS clinscore,",
                                "ukbb_t1_phenotype.mean",
                                "FROM clinicaldata",
                                "JOIN ukbb_t1_phenotype, demogs, baseline ON clinicaldata.eid = ukbb_t1_phenotype.eid",
                                "AND clinicaldata.eid = demogs.eid",
                                "AND clinicaldata.visit = demogs.visit",
                                "AND clinicaldata.eid = baseline.eid",
                                "AND ukbb_t1_phenotype.eid = demogs.eid",
                                "WHERE demogs.age IS NOT ''",
                                "AND baseline.imaging = 1",
                                "AND", paste("demogs", clinscore, sep = "."), "IS NOT ''"))) %>%
    filter(visit == 2)

alldata$adlike <- sapply(alldata$mean,
                         function(x, thr) if (x >=  thr) { return("Positive") } else {return("Negative")},
                         thr = threshold)

alldata <- alldata %>%
  mutate(adlike = ifelse(noncancer_code_selfreported == "1263", "AD", adlike)) %>%
  filter(adlike != "AD") # filter out those with AD at recruitment


alldata$adlike <- as.factor(alldata$adlike)
alldata$clinscore <- as.numeric(alldata$clinscore)
alldata$age <- as.numeric(alldata$age)

# normalise age
mean_age <- mean(alldata$age)
sd_age <- sd(alldata$age)
alldata$age <- (alldata$age - mean_age) / sd_age
  
alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
# change to proportions
total_pos = length(alldata[alldata$adlike == "Positive", "eid"])
total_neg = length(alldata[alldata$adlike == "Negative", "eid"])

alldata_summary <- alldata %>%
  group_by(adlike, clinscore) %>%
  summarise(n = length(eid))
alldata_summary$totals <- sapply(alldata_summary$adlike,
                                 function(x, total_pos, total_neg) if (x == "Positive") {return(total_pos)} else {return(total_neg)},
                                 total_pos = total_pos,
                                 total_neg = total_neg)
alldata_summary <- alldata_summary %>%
  group_by(adlike, clinscore) %>%
  mutate(proportion = n / totals)

p <- ggplot(alldata_summary,
            aes(y = proportion,
                x = adlike,
                fill = clinscore)) +
  geom_histogram(stat = "identity",
                 position = position_dodge2()) +
  labs(x = clinscore) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# Bayesian analysis
priors <- c(prior(normal(0,10), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"))

cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata,
                iter = 5000, warmup = 1000, chains = 4,
                family = bernoulli(),
                prior = priors)

summary(cog_brms)

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
ce <- conditional_effects(cog_brms, "adlike")

# ROPE for odds ratios in logistic regression
# https://cran.r-project.org/web/packages/bayestestR/vignettes/region_of_practical_equivalence.html
# or_rope = pi / sqrt(3) * ce$adlike$estimate__[[1]] 
or_rope = 0.01

plot(ce, plot = FALSE,
     errorbar_args = list(width = 0))[[1]] +
  labs(y = clinscore_name,
       x = "AD-like") +
  coord_flip() +
  scale_x_discrete(limits = c("Positive",
                              "Negative"),
                   labels = c("AD-like positive",
                              "AD-like negative")) +
  geom_rect(ymin = ce$adlike$estimate__[[1]] - or_rope,
            ymax = ce$adlike$estimate__[[1]] + or_rope,
            xmin = 0, xmax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_hline(yintercept = ce$adlike$estimate__[[1]], linetype = "dashed", colour = "blue") +
  geom_hline(yintercept = ce$adlike$estimate__[[1]] + or_rope, linetype = "dashed", colour = "blue") +
  geom_hline(yintercept = ce$adlike$estimate__[[1]] - or_rope, linetype = "dashed", colour = "blue") +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```


```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```

## Never smoker vs ever smoked
```{r}
clinscore = "smoking_status"
clinscore_name = "Smoking history"

# pairs matching
alldata <- dbGetQuery(ukbb.db,
                      sql(paste("SELECT clinicaldata.eid, clinicaldata.noncancer_code_selfreported,",
                                "demogs.age, demogs.visit,",
                                paste("demogs", clinscore, sep = "."), " AS clinscore,",
                                "ukbb_t1_phenotype.mean",
                                "FROM clinicaldata",
                                "JOIN ukbb_t1_phenotype, demogs, baseline ON clinicaldata.eid = ukbb_t1_phenotype.eid",
                                "AND clinicaldata.eid = demogs.eid",
                                "AND clinicaldata.visit = demogs.visit",
                                "AND clinicaldata.eid = baseline.eid",
                                "AND ukbb_t1_phenotype.eid = demogs.eid",
                                "WHERE demogs.age IS NOT ''",
                                "AND baseline.imaging = 1",
                                "AND", paste("demogs", clinscore, sep = "."), "IS NOT ''"))) %>%
    filter(visit == 2)

alldata$adlike <- sapply(alldata$mean,
                         function(x, thr) if (x >=  thr) { return("Positive") } else {return("Negative")},
                         thr = threshold)

alldata <- alldata %>%
  mutate(adlike = ifelse(noncancer_code_selfreported == "1263", "AD", adlike)) %>%
  filter(adlike != "AD") # filter out those with AD at recruitment


alldata$adlike <- as.factor(alldata$adlike)
alldata$clinscore <- as.numeric(alldata$clinscore)
alldata$age <- as.numeric(alldata$age)

# normalise age
mean_age <- mean(alldata$age)
sd_age <- sd(alldata$age)
alldata$age <- (alldata$age - mean_age) / sd_age
  
alldata <- alldata %>%
  filter(clinscore >= 0)

# convert to current vs ex/non-smoker
alldata <- alldata %>%
  mutate(clinscore = replace(clinscore, clinscore == 2, 1))

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))

```

```{r}
# change to proportions
total_pos = length(alldata[alldata$adlike == "Positive", "eid"])
total_neg = length(alldata[alldata$adlike == "Negative", "eid"])

alldata_summary <- alldata %>%
  group_by(adlike, clinscore) %>%
  summarise(n = length(eid))
alldata_summary$totals <- sapply(alldata_summary$adlike,
                                 function(x, total_pos, total_neg) if (x == "Positive") {return(total_pos)} else {return(total_neg)},
                                 total_pos = total_pos,
                                 total_neg = total_neg)
alldata_summary <- alldata_summary %>%
  group_by(adlike, clinscore) %>%
  mutate(proportion = n / totals)

p <- ggplot(alldata_summary,
            aes(y = proportion,
                x = adlike,
                fill = clinscore)) +
  geom_histogram(stat = "identity",
                 position = position_dodge2()) +
  labs(x = clinscore) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# Bayesian analysis
priors <- c(prior(normal(0,10), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"))

cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata,
                iter = 5000, warmup = 1000, chains = 4,
                family = bernoulli(),
                prior = priors)

summary(cog_brms)

summary(cog_brms)

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
ce <- conditional_effects(cog_brms, "adlike")

# ROPE for odds ratios in logistic regression
# https://cran.r-project.org/web/packages/bayestestR/vignettes/region_of_practical_equivalence.html
# or_rope = pi / sqrt(3) * ce$adlike$estimate__[[1]] 
or_rope = 0.01

plot(ce, plot = FALSE,
     errorbar_args = list(width = 0),
     cat_args = list(size = 2))[[1]] +
  labs(y = clinscore_name,
       x = "AD-like") +
  coord_flip() +
  scale_x_discrete(limits = c("Positive",
                              "Negative"),
                   labels = c("AD-like positive",
                              "AD-like negative")) +
  geom_rect(ymin = ce$adlike$estimate__[[1]] - or_rope,
            ymax = ce$adlike$estimate__[[1]] + or_rope,
            xmin = 0, xmax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_hline(yintercept = ce$adlike$estimate__[[1]], linetype = "dashed", colour = "blue") +
  geom_hline(yintercept = ce$adlike$estimate__[[1]] + or_rope, linetype = "dashed", colour = "blue") +
  geom_hline(yintercept = ce$adlike$estimate__[[1]] - or_rope, linetype = "dashed", colour = "blue") +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```


```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```

## Current Smoking vs non-smokers
```{r}
clinscore = "smoking_status"
clinscore_name = "Smoking status"

# pairs matching
alldata <- dbGetQuery(ukbb.db,
                      sql(paste("SELECT clinicaldata.eid, clinicaldata.noncancer_code_selfreported,",
                                "demogs.age, demogs.visit,",
                                paste("demogs", clinscore, sep = "."), " AS clinscore,",
                                "ukbb_t1_phenotype.mean",
                                "FROM clinicaldata",
                                "JOIN ukbb_t1_phenotype, demogs, baseline ON clinicaldata.eid = ukbb_t1_phenotype.eid",
                                "AND clinicaldata.eid = demogs.eid",
                                "AND clinicaldata.visit = demogs.visit",
                                "AND clinicaldata.eid = baseline.eid",
                                "AND ukbb_t1_phenotype.eid = demogs.eid",
                                "WHERE demogs.age IS NOT ''",
                                "AND baseline.imaging = 1",
                                "AND", paste("demogs", clinscore, sep = "."), "IS NOT ''"))) %>%
    filter(visit == 2)

alldata$adlike <- sapply(alldata$mean,
                         function(x, thr) if (x >=  thr) { return("Positive") } else {return("Negative")},
                         thr = threshold)

alldata <- alldata %>%
  mutate(adlike = ifelse(noncancer_code_selfreported == "1263", "AD", adlike)) %>%
  filter(adlike != "AD") # filter out those with AD at recruitment


alldata$adlike <- as.factor(alldata$adlike)
alldata$clinscore <- as.numeric(alldata$clinscore)
alldata$age <- as.numeric(alldata$age)

# normalise age
mean_age <- mean(alldata$age)
sd_age <- sd(alldata$age)
alldata$age <- (alldata$age - mean_age) / sd_age
  
alldata <- alldata %>%
  filter(clinscore >= 0)

# convert to current vs ex/non-smoker
alldata <- alldata %>%
  mutate(clinscore = replace(clinscore, clinscore == 0, 1))

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))

```

```{r}
# change to proportions
total_pos = length(alldata[alldata$adlike == "Positive", "eid"])
total_neg = length(alldata[alldata$adlike == "Negative", "eid"])

alldata_summary <- alldata %>%
  group_by(adlike, clinscore) %>%
  summarise(n = length(eid))
alldata_summary$totals <- sapply(alldata_summary$adlike,
                                 function(x, total_pos, total_neg) if (x == "Positive") {return(total_pos)} else {return(total_neg)},
                                 total_pos = total_pos,
                                 total_neg = total_neg)
alldata_summary <- alldata_summary %>%
  group_by(adlike, clinscore) %>%
  mutate(proportion = n / totals)

p <- ggplot(alldata_summary,
            aes(y = proportion,
                x = adlike,
                fill = clinscore)) +
  geom_histogram(stat = "identity",
                 position = position_dodge2()) +
  labs(x = clinscore) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# Bayesian analysis
priors <- c(prior(normal(0,10), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"))

cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata,
                iter = 5000, warmup = 1000, chains = 4,
                family = bernoulli(),
                prior = priors)

summary(cog_brms)

summary(cog_brms)

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
ce <- conditional_effects(cog_brms, "adlike")

# ROPE for odds ratios in logistic regression
# https://cran.r-project.org/web/packages/bayestestR/vignettes/region_of_practical_equivalence.html
# or_rope = pi / sqrt(3) * ce$adlike$estimate__[[1]] 
or_rope = 0.01

plot(ce, plot = FALSE,
     errorbar_args = list(width = 0))[[1]] +
  labs(y = clinscore_name,
       x = "AD-like") +
  coord_flip() +
  scale_x_discrete(limits = c("Positive",
                              "Negative"),
                   labels = c("AD-like positive",
                              "AD-like negative")) +
  geom_rect(ymin = ce$adlike$estimate__[[1]] - or_rope,
            ymax = ce$adlike$estimate__[[1]] + or_rope,
            xmin = 0, xmax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_hline(yintercept = ce$adlike$estimate__[[1]], linetype = "dashed", colour = "blue") +
  geom_hline(yintercept = ce$adlike$estimate__[[1]] + or_rope, linetype = "dashed", colour = "blue") +
  geom_hline(yintercept = ce$adlike$estimate__[[1]] - or_rope, linetype = "dashed", colour = "blue") +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```


```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```
# Smoking pack years

```{r}
clinscore = "smoking_packyears"
clinscore_name = "Smoking pack years"

# pairs matching
alldata <- dbGetQuery(ukbb.db,
                      sql(paste("SELECT clinicaldata.eid, clinicaldata.noncancer_code_selfreported,",
                                "demogs.age, demogs.visit,",
                                paste("demogs", clinscore, sep = "."), " AS clinscore,",
                                "ukbb_t1_phenotype.mean",
                                "FROM clinicaldata",
                                "JOIN ukbb_t1_phenotype, demogs, baseline ON clinicaldata.eid = ukbb_t1_phenotype.eid",
                                "AND clinicaldata.eid = demogs.eid",
                                "AND clinicaldata.visit = demogs.visit",
                                "AND clinicaldata.eid = baseline.eid",
                                "AND ukbb_t1_phenotype.eid = demogs.eid",
                                "WHERE demogs.age IS NOT ''",
                                "AND baseline.imaging = 1",
                                "AND", paste("demogs", clinscore, sep = "."), "IS NOT ''"))) %>%
    filter(visit == 2)

alldata$adlike <- sapply(alldata$mean,
                         function(x, thr) if (x >=  thr) { return("Positive") } else {return("Negative")},
                         thr = threshold)

alldata <- alldata %>%
  mutate(adlike = ifelse(noncancer_code_selfreported == "1263", "AD", adlike)) %>%
  filter(adlike != "AD") # filter out those with AD at recruitment


alldata$adlike <- as.factor(alldata$adlike)
alldata$clinscore <- as.numeric(alldata$clinscore)
alldata$age <- as.numeric(alldata$age)

# normalise age
mean_age <- mean(alldata$age)
sd_age <- sd(alldata$age)
alldata$age <- (alldata$age - mean_age) / sd_age
  
alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))

```

```{r}
p <- ggplot(alldata,
            aes(y = clinscore,
                x = adlike,
                fill = adlike)) +
  geom_boxplot() +
  labs(y = clinscore_name) +
  theme(axis.title.x = element_blank(),
        legend.position = "None",
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)

```

```{r}
# Bayesian analysis
priors <- c(prior(normal(20, 50), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"), 
            prior(cauchy(0, 10), class = "sigma"))

cog_brms <- brm(clinscore ~ adlike + age, 
                data = alldata, 
                iter = 5000, warmup = 1000, chains = 4, 
                prior = priors)

summary(cog_brms)

```

```{r}
summary_model <- summary(cog_brms)

cog_brms %>%
  spread_draws(b_adlikePositive) %>%
  ggplot(aes(x = b_adlikePositive)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(b_adlikePositive)),
             colour = "blue",
             linetype = "dashed") +
  geom_vline(xintercept = summary_model$fixed[2,3],
             colour = "blue",
             linetype = "dashed") + 
  geom_vline(xintercept = summary_model$fixed[2,4],
             colour = "blue",
             linetype = "dashed")

```

```{r, fig.height=2.5, fig.width=6}
cog_brms_draws <- cog_brms %>%
  spread_draws(b_adlikePositive, b_Intercept)

mean_intercept = mean(cog_brms_draws$b_Intercept)
sd_control = sd(alldata[alldata$adlike == "Negative", "clinscore"]) * 0.1

cog_brms_draws %>%
  dplyr::select(b_adlikePositive, b_Intercept) %>%
  mutate(b_adlikePositive = mean_intercept + b_adlikePositive) %>%
  pivot_longer(cols = c(b_adlikePositive, b_Intercept)) %>%
  group_by(name) %>%
  median_qi(.width = c(.8, .95)) %>%
  ggplot(aes(y = name, x = value, xmin = .lower, xmax = .upper)) +
  geom_rect(xmin = mean_intercept - sd_control,
            xmax = mean_intercept + sd_control,
            ymin = 0, ymax = 3,
            fill = "cornsilk3") +
  geom_pointinterval() +
  geom_vline(xintercept = mean_intercept, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept + sd_control, linetype = "dashed", colour = "blue") +
  geom_vline(xintercept = mean_intercept - sd_control, linetype = "dashed", colour = "blue") +
  scale_y_discrete(labels = c("AD-like positive", "AD-like negative")) +
  labs(x = clinscore_name) +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 15),
        axis.title.x = element_text(size = 15))
```




# Falls
```{r}
clinscore = "falls_last_year"
clinscore_name = "Falls"

alldata <- getdata(clinscore = clinscore,
                   threshold = threshold) %>%
  filter(clinscore >= 0)

alldata %>%
  group_by(adlike, visit) %>%
  summarise(n = length(eid))
```

```{r}
# change to proportions
total_pos = length(alldata[alldata$adlike == "Positive", "eid"][["eid"]])
total_neg = length(alldata[alldata$adlike == "Negative", "eid"][["eid"]])

alldata_summary <- alldata %>%
  group_by(adlike, clinscore) %>%
  summarise(n = length(eid))
alldata_summary$totals <- sapply(alldata_summary$adlike,
                                 function(x, total_pos, total_neg) if (x == "Positive") {return(total_pos)} else {return(total_neg)},
                                 total_pos = total_pos,
                                 total_neg = total_neg)
alldata_summary <- alldata_summary %>%
  group_by(adlike, clinscore) %>%
  mutate(proportion = n / totals)

p <- ggplot(alldata_summary,
            aes(y = proportion,
                x = adlike,
                fill = clinscore)) +
  geom_histogram(stat = "identity",
                 position = position_dodge2()) +
  labs(x = clinscore) +
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20))

print(p)
```


```{r}
# priors
priors <- c(prior(cauchy(0, 10), class = "Intercept"), 
            prior(cauchy(0, 10), class = "b"))

# Bayesian analysis
cog_brms <- brm(clinscore ~  1 + adlike + age, 
                data = alldata, 
                iter = 5000, warmup = 1000, chains = 4,
                family = acat("probit"),
                prior = priors)

summary(cog_brms)
```

```{r}
ce <- conditional_effects(cog_brms, "adlike", categorical = TRUE)

p2 <- plot(ce, plot = FALSE)[[1]] +
  ylim(.75, .85) +
  theme(legend.position = "None",
        axis.title.x = element_blank())

p3 <- plot(ce, plot = FALSE)[[1]] +
  ylim(0., .2) +
  theme(legend.position = "None",
        axis.title.x = element_blank())

p1 <- plot(ce, plot = FALSE)[[1]] +
  labs(x = "AD-like") +
  scale_fill_discrete(name = clinscore_name,
                      labels = c("No falls",
                                 "1 fall",
                                 "> 1 fall")) +
  scale_colour_discrete(name = clinscore_name,
                        labels = c("No falls",
                                   "1 fall",
                                   "> 1 fall"))

grid.arrange(grobs = list(p1, p2, p3),
             widths = c(2,1),
             layout_matrix = rbind(c(1,2),
                                   c(1,3)))

```


